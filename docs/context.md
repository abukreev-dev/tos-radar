# Контекст обсуждения MVP ToS Radar

Ниже зафиксированы все согласованные решения из обсуждения, чтобы не потерять контекст.

## Цель

Скрипт, который раз в сутки (cron) проверяет изменения в ToS-документах сервисов, сравнивает с предыдущей версией и показывает изменения.

## Ограничения и требования

- Планируемый объем: 300–500 документов в час.
- Источники ToS фиксированные (в MVP без автопоиска).
- Формат входа для MVP: текстовый файл со списком URL.
- Один домен = один URL в MVP.
- Дубли домена в конфиге считаются ошибкой.

## Технические решения

- Стек MVP: `Python 3.12 + Playwright`.
- Менеджмент зависимостей: `venv + pip + requirements.txt`.
- Рантайм-конфигурация через `.env`.
- Хранилище данных: файлы на диске (без БД в MVP).
- Обработка изменений по “чистому тексту”, а не по HTML.
- По возможности удалять шум (ссылки, навигация, футер и т.д.) эвристиками.
- PDF поддерживается (если URL указывает на PDF-документ).
- По ссылкам со страницы в MVP не переходим.

## Сеть и ретраи

- Первая попытка: без прокси.
- Прокси предоставляются пользователем списком.
- Если первая попытка неудачна: до 3 попыток через разные прокси.
- Таймаут на URL: 60 секунд.
- Если не удалось получить документ: статус `FAILED`, выполнение продолжается.
- Финальным считается результат последней успешной попытки.

## Параллелизм и ресурсы

- Сервер: 8 vCPU / 16 GB RAM.
- Для MVP согласован дефолтный параллелизм: `concurrency = 20`.

## Логика сравнения и версионирования

- Триггер изменения: любое текстовое отличие.
- Дата обновления важна и не должна игнорироваться (это валидный сигнал изменения).
- Нормализация текста:
- lowercase;
- схлопывание пробелов/переносов;
- игнорирование пунктуации.
- После `CHANGED` baseline обновляется на новую версию.
- Для `FAILED` baseline не меняется.
- Хранение версий: достаточно двух последних (`current + previous`).
- Первый запуск делается отдельно через `make init` (сбор baseline, без diff-режима).

## Отчетность и логи

- В MVP только:
- общий HTML-отчет на запуск;
- логи в консоль и файл.
- Статусы в отчете: `CHANGED`, `UNCHANGED`, `FAILED` (и `NEW` для init-режима при необходимости).
- Для `CHANGED` — встроенный подсвеченный diff “до/после”.
- В записи отчета: `domain`, `url`, `status`, время обработки, источник (`HTML/PDF`), diff при изменениях.
- Таймзона для логов/отчета: локальная серверная.
- Логи: `logs/run-YYYYMMDD-HHMMSS.log`, формат `timestamp level domain message`.

## Make-цели для MVP

- `make init`
- `make run`
- `make test`
- `make lint`
- `make report-open`

## Тестирование MVP

- Unit-тесты:
- нормализация текста;
- сравнение;
- парсинг конфигов;
- ротация попыток.
- Интеграционные тесты с реальными сайтами в MVP не обязательны.

## Отложено на полный релиз

- UI с аккаунтами пользователей.
- Выбор сервисов пользователями из подключенных.
- Добавление пользовательских URL.
- Автопоиск ToS по сайту.
- Обработка сценариев “страница со ссылкой на документ” и поиск актуальной версии.
- Расширенные уведомления (Telegram/email/webhook).
- БД и расширенная история.
