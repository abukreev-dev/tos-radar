# Актуальный контекст (кратко)

Дата обновления: 2026-02-21

## Сессия UI клиента (доп. контекст)

- Подробный лог решений по клиентскому веб-интерфейсу: `docs/client_ui_context_2026-02-21.md`
- Точка продолжения интервью: вопрос `#237`

## Цель

Автоматически мониторить изменения ToS-документов по фиксированным URL, сравнивать с baseline и формировать HTML-отчет.

## Текущий рабочий контур

- Запуски: `init`, `run`, `rerun-failed`, `report-open`.
- Основной режим: `make run`.
- После `run` автоматически выполняется один повтор для доменов со статусом `FAILED`.
- Для ручного догоняющего прогона есть `make rerun-failed`.

## Источники и ограничения

- Вход: `config/tos_urls.txt`.
- Дубли доменов не роняют запуск: берется первый URL, остальные пропускаются.
- Поддерживаются HTML и прямые PDF URL.
- По ссылкам со страницы в MVP не переходим.

## Качество извлечения

- Quality gates:
  - `SHORT_CONTENT` (слишком короткий HTML);
  - `TECHNICAL_PAGE` (тех/блок-страницы).
- В отчете выводится `text_length` для быстрой визуальной валидации документа.

## Классификация изменений

- `change_level`: `NOISE`, `MINOR`, `MAJOR`.
- `change_ratio`: доля изменений.
- Отдельный раздел отчета: `Suspicious CHANGED`.

## Ретраи и таймауты

- 1 попытка без прокси + до `RETRY_PROXY_COUNT` прокси.
- Exponential backoff + jitter.
- Жесткий timeout на попытку и на сервис целиком.

## Multi-tenant

Все данные разделены по `TENANT_ID`:

- `data/state/<tenant_id>/<domain>/...`
- `data/<tenant_id>/last_failed_urls.txt`
- `logs/<tenant_id>/...`
- `reports/<tenant_id>/...`

## Что считать нормальным после релизов

- При смене формата хранения текста возможен одноразовый всплеск `CHANGED`.
- После стабилизации второй/третий прогон должен возвращаться к реальным изменениям.
